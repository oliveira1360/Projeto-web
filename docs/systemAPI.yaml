openapi: 3.0.3
info:
  title: Chelas Multi-Player Poker Dice API
  version: 1.0.0
  description: |
    **Group Identification:** LEIC52D-G14

    **Group Members:**
    - Diogo Oliveira - A51662
    - Paulo Nascimento - A51665
    - Jess√© Alencar - A51745

    **GitHub Repository:** https://github.com/isel-leic-daw/2025-daw-leic52d-2025-leic52d-14.git

    **Contact Information:**
    - A51662@alunos.isel.pt
    - A51665@alunos.isel.pt
    - A51745@alunos.isel.pt

servers:
  - description: Localhost server for testing API
    url: http://localhost:8080

tags:
  - name: Users
  - name: Games

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: TokenValidationInfo  # Usando o formato de token em String

  schemas:
    CreateUserDTO:
      type: object
      required: [ name, nickName, email, password ]
      properties:
        name:
          type: string
        nickName:
            type: string
        email:
          type: string
        password:
          type: string
        imageUrl:
            type: string
            required: false
    User:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        nickName:
          type: string
        email:
          type: string
        imageUrl:
          type: string
    UserError:
      type: object  # Sealed class that represents possible user related errors

    LoginUserDTO:
      type: object
      required: [ email, password ]
      properties:
        email:
          type: string
        password:
          type: string
    TokenExternalInfo:
      type: object
      properties:
        tokenValue:
          type: string
        tokenExpiration:
          type: string
          format: date-time # Java Instant format
    TokenCreationError:
      type: object  # Sealed class that represents possible token related errors

    AuthenticatedUserDTO:
      type: object
      required: [ user, token ]
      properties:
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
    UpdateUserDTO:
      type: object
      properties:
        name:
          type: string
        nickName:
          type: string
        password:
          type: string
        imageUrl:
          type: string
    UserInfo:
      type: object
      properties:
        userId:
          type: integer
        totalGamesPlayed:
          type: integer
        totalWins:
          type: integer
        totalLosses:
          type: integer
        totalPoints:
          type: integer
        longestStreak:
          type: integer
        currentStreak:
          type: integer

    Lobby:
      type: object
      properties:
        id:
          type: integer
          description: Lobby identifier
        name:
          type: string
        maxPlayers:
          type: integer
        currentPlayers:
          type: integer
        rounds:
          type: integer
        status:
          type: string
        players:
          type: array
          items:
            type: object
            properties:
              playerId:
                type: integer
              nickName:
                type: string
        _links:
          type: object
          additionalProperties: true
    CreateLobbyDTO:
      type: object
      required: [ name, maxPlayers ]
      properties:
        name:
          type: string
          description: Name of the lobby
        maxPlayers:
          type: integer
          description: Maximum number of players allowed
        rounds:
          type: integer
          description: Number of rounds for the game (optional)
    LobbyError:
      type: object
      properties:
        type:
          type: string
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
      additionalProperties: true

    CreateGameDTO:
      type: object
      required: [ lobbyId ]
      properties:
        lobbyId:
          type: integer
          description: Identifier of the lobby where the game will be created
    CreatedGame:
      type: object
      properties:
        gameId:
          type: integer
          description: The newly created game's id
        status:
          type: string
          description: Current game status
        _links:
          type: object
          additionalProperties: true
          description: HATEOAS links for the created resource
    Game:
      type: object
      properties:
        id:
          type: integer
        status:
          type: string
        players:
          type: array
          items:
            $ref: '#/components/schemas/PlayerInGame'
        roundNumber:
          type: integer
        _links:
          type: object
          additionalProperties: true
    GameError:
      type: object
      properties:
        type:
          type: string
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
      additionalProperties: true
    PlayerInGame:
      type: object
      properties:
        playerId:
          type: integer
        nickName:
          type: string
    ListPlayersInGame:
      type: object
      properties:
        players:
          type: array
          items:
            $ref: '#/components/schemas/PlayerInGame'
        _links:
          type: object
          additionalProperties: true
    RoundStartResponse:
      type: object
      properties:
        roundNumber:
          type: integer
        message:
          type: string
        _links:
          type: object
          additionalProperties: true
    Hand:
      type: object
      properties:
        hand:
          type: array
          items:
            type: string
        _links:
          type: object
          additionalProperties: true
    ShuffleDTO:
      type: object
      properties:
        lockedDice:
          type: array
          items:
            type: integer
          description: Indexes of dice to keep (0-based)
    Points:
      type: object
      properties:
        points:
          type: integer
        combination:
          type: string
    FinishTurnResponse:
      type: object
      properties:
        points:
          $ref: '#/components/schemas/Points'
        finished:
          type: boolean
        _links:
          type: object
          additionalProperties: true
    RoundWinnerInfo:
      type: object
      properties:
        winner:
          type: object
          properties:
            playerId:
              type: integer
            points:
              type: integer
            handValue:
              type: string
            roundNumber:
              type: integer
        _links:
          type: object
          additionalProperties: true
    GameWinnerInfo:
      type: object
      properties:
        winner:
          type: object
          properties:
            playerId:
              type: integer
            totalPoints:
              type: integer
            roundsWon:
              type: integer
        _links:
          type: object
          additionalProperties: true
    Time:
      type: object
      properties:
        remainingSeconds:
          type: number
          description: The number of milliseconds since January 1, 1970, 00:00:00 GMT represented by this Date object. (Java Date Object format)
        _links:
          type: object
          additionalProperties: true
    RoundInfo:
      type: object
      properties:
        round:
          type: integer
        players:
          type: integer
        _links:
          type: object
          additionalProperties: true
    Scoreboard:
      type: object
      properties:
        players:
          type: array
          items:
            type: object
            properties:
              playerId:
                type: integer
              points:
                type: integer
        _links:
          type: object
          additionalProperties: true

paths:

  /users/create:
    post:
      tags:
        - Users
      summary: Create a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserDTO'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'

  /users/login:
    post:
      tags:
        - Users
      summary: User Login Operation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginUserDTO'
      responses:
        '202':
          description: User logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenExternalInfo'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenCreationError'

  /users/logout:
    post:
      tags:
        - Users
      summary: User Logout Operation
      security:
        - BearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthenticatedUserDTO'
      responses:
        '202':
          description: User logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenExternalInfo'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenCreationError'

  /users/info:
    get:
      tags:
       - Users
      summary: Get the authenticated user's information
      security:
        - BearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthenticatedUserDTO'
      responses:
        '200':
          description: User information retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /users/stats:
    get:
      tags:
        - Users
      summary: Get the authenticated user's game statistics
      security:
        - BearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthenticatedUserDTO'
      responses:
        '200':
          description: User information retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'

  /users/update:
    post:
      tags:
        - Users
      summary: Update the authenticated user's information
      security:
        - BearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserDTO'
      responses:
        '202':
          description: User information updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'


  /lobbies:
    get:
      tags:
        - Games
      summary: List all lobbies.
      responses:
        '200':
          description: Lobbies retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Lobby'

  /lobbies/create:
    post:
      tags:
        - Games
      summary: Creates a new lobby.
      security:
        - BearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLobbyDTO'
      responses:
        '201':
          description: Lobby created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lobby'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyError'

  /lobbies/{lobbyId}:
    get:
      tags:
        - Games
      summary: Get lobby details by ID.
      parameters:
        - in: path
          name: lobbyId
          schema:
            type: integer
          required: true
          description: The unique identifier of the lobby.
      responses:
        '200':
          description: Lobby retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lobby'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyError'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyError'

  /lobbies/join/{lobbyId}:
    post:
      tags:
        - Games
      summary: Join a lobby.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: lobbyId
          schema:
            type: integer
          required: true
          description: The unique identifier of the lobby to join.
      responses:
        '202':
          description: Joined lobby successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lobby'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyError'

  /lobbies/leave/{lobbyId}:
    post:
      tags:
        - Games
      summary: Leave a lobby.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: lobbyId
          schema:
            type: integer
          required: true
          description: The unique identifier of the lobby to leave.
      responses:
        '202':
          description: Left lobby successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lobby'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyError'

  /game:
    post:
      tags:
        - Games
      summary: Creates a new game instance.
      security:
        - BearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGameDTO'
      responses:
        '201':
          description: Game created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatedGame'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}:
    get:
      tags:
        - Games
      summary: Get game details by ID.
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      responses:
        '200':
          description: Game retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Game'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'
    post:
      tags:
        - Games
      summary: Closes/deletes a game.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game to be closed.
      responses:
        '204':
          description: Game closed successfully (no content)
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/players:
    get:
      tags:
        - Games
        - Users
      summary: Returns a list of all players currently participating in the given game.
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      responses:
        '200':
          description: List of players retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListPlayersInGame'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/round/start:
    post:
      tags:
        - Games
      summary: Starts a new round.
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game where the round will be started.
      responses:
        '201':
          description: Round started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoundStartResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/player/hand:
    get:
      tags:
        - Games
      summary: Returns the current hand of the authenticated player.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      responses:
        '200':
          description: Player's hand retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Hand'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/player/shuffle:
    post:
      tags:
        - Games
      summary: Shuffle/roll dice.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShuffleDTO'
      responses:
        '200':
          description: Player's hand shuffled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Hand'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/player/finish:
    put:
      tags:
        - Games
      summary: Finish turn and calculate points.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      responses:
        '200':
          description: Player's turn finished successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Points'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/round/winner:
    get:
      tags:
        - Games
      summary: Returns the winner of the current round.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      responses:
        '200':
          description: Round winner retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoundWinnerInfo'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/winner:
    get:
      tags:
        - Games
      summary: Returns the overall game winner after all rounds have been played. Includes total scores and final ranking of players.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      responses:
        '200':
          description: Game winner retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameWinnerInfo'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/remaining-time:
    get:
      tags:
        - Games
      summary: Returns the remaining time (in seconds) before the game auto-starts.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      responses:
        '200':
          description: Remaining time retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Time'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/round:
    get:
      tags:
        - Games
      summary: Get current round info.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      responses:
        '200':
          description: Round info retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoundInfo'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'

  /game/{gameId}/scores:
    get:
      tags:
        - Games
      summary: Returns the current scoreboard of the game, listing all players and their cumulative points.
      security:
        - BearerAuth: [ ]
      parameters:
        - in: path
          name: gameId
          schema:
            type: integer
          required: true
          description: The unique identifier of the game.
      responses:
        '200':
          description: Scoreboard retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Scoreboard'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameError'